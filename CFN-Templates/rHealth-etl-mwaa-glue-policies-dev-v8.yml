AWSTemplateFormatVersion: "2010-09-09"
Description: Template for rHealth Workflow roles and policies in Development

#----------------------------------------------------PARAMETERS----------------------------------------------------------------
Parameters:
  SNSTopicARN:
    Type: String
    Description: Enter the ARN of the Development SNS topic for noticiations.
    Default: arn:aws:sns:us-east-1:235615209784:rhealth-etl-dev.fifo

  VPCxPermissionBoundary:
    Type: String
    Description: Enter the ARN of the VPCx required Permission Boundary.
    Default: arn:aws:iam::235615209784:policy/itx/core/VpcxPermissionsBoundaryPolicy1

  #rHealthS3IngestBucketArn:
  #  Type: String
  #  Description: Enter the ARN of the rHealth workflow Development S3 ingest bucket

  rHealthS3LandingBucketArn:
    Type: String
    Description: Enter the ARN of the rHealth workflow Development S3 landing bucket
    Default: arn:aws:s3:::itx-agu-ingest-dev

  rHealthS3LakeBucketArn:
    Type: String
    Description: Enter the ARN of the rHealth workflow Development S3 lake bucket
    Default: arn:aws:s3:::itx-agu-lake-dev

  #S3KMSIngestKeyArn:
  #  Type: String
  #  Description: Enter the ARN of the Development S3 ingest KMS Key CMK.

  #S3KMSLakeKeyArn:
  #  Type: String
  #  Description: Enter the ARN of the Development S3 Lake KMS Key CMK.

  #S3KMSLandingKeyArn:
  #  Type: String
  #  Description: Enter the ARN of the Development S3 Landing KMS Key CMK.

  #CloudWatchKMSKeyArn:
  #  Type: String
  #  Description: Enter the ARN for the Development CloudWatch KMS Key CMK.

  #MWAAS3BucketArn:
  # Type: String
  # Description: Enter the ARN of the rHealth MWAA env bucket

  MWAAS3BucketArn:
    Type: String
    Description: Enter the ARN of the rHealth MWAA env bucket


  #EnvironmentName:
  #  Type: String
  #  Description: Enter the name of the rHealth MWAA env name
  #  Default: rhealth-etl-dev-MwaaEnvironment

  MWAAVersion:
    Type: String
    Description: The version of Apache Airflow to use for the environment. If no value is specified, defaults to the latest version.
    Default: 2.2.2

  VpcId:
    Type: String
    Description: VPC id
    Default: vpc-0b45275c2f0879893	

  Subnet1:
    Type: String
    Description: Subnet in which to launch an MWAA
    Default: subnet-0ea178e5d59ba0501

  Subnet2:
    Type: String
    Description: Subnet in which to launch an MWAA
    Default: subnet-012bdad606bdab91b

  ExistingSecurityGroup:
    Type: CommaDelimitedList
    Description: ID's of an existing VPC security group (sg-xxxxxx)
    Default: sg-0ccd74cde8ecd80b3,sg-0a0c2e01ca03a6a57,sg-0d7d27407c08c500e,sg-0e9de038c40382a83

  MaxWorkerNodes:
    Description: The maximum number of workers that can run in the environment
    Type: Number
    Default: 2

  DagProcessingLogs:
    Description: Log level for DagProcessing
    Type: String
    Default: INFO

  SchedulerLogsLevel:
    Description: Log level for SchedulerLogs
    Type: String
    Default: INFO

  TaskLogsLevel:
    Description: Log level for TaskLogs
    Type: String
    Default: INFO

  WorkerLogsLevel:
    Description: Log level for WorkerLogs
    Type: String
    Default: INFO

  WebserverLogsLevel:
    Description: Log level for WebserverLogs
    Type: String
    Default: INFO

# S3BucketName:
#   Type: String

  EnvClass:
    Type: String
    Description: The environment class depending on the amount of airflow DAGs
    Default: mw1.small
    
#-----------------------------------------------------RESOURCES---------------------------------------------------------------

Resources:
  rHealthWorkflowGlueToAccessS3CloudwatchlogsDev:
    Type: AWS::IAM::Role
    Properties:
      Description: Role used by Glue for the rHealth workflow in development.
      Path: '/'
      RoleName: rhealth-etl-dev-workflow-Glue-access-S3-cw-logs-etl-dev
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - glue.amazonaws.com
            Action:
              - sts:AssumeRole
      ManagedPolicyArns: 
        - arn:aws:iam::aws:policy/SecretsManagerReadWrite
        - arn:aws:iam::aws:policy/AWSGlueConsoleFullAccess
        - arn:aws:iam::aws:policy/service-role/AWSGlueServiceRole
      PermissionsBoundary: !Ref VPCxPermissionBoundary
      Tags:
       - Key: Environment
         Value: rhealth-etl-dev

  rHealthWorkflowSnsNotificationPublishDev:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: IAM Policy for rHealth Workflow SNS Notifications
      Path: '/'
      ManagedPolicyName: rhealth-etl-dev-workflow-Sns-Notification-Publish
      Roles:
        - !Ref rHealthWorkflowGlueToAccessS3CloudwatchlogsDev
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - sns:Publish
            Resource: !Ref SNSTopicARN
            Condition:
              StringEquals:
                aws:ResourceTag/Environment: rhealth-etl-dev

  rHealthWorkflowGlueCloudwatchLogsDev:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: IAM Policy for rHealth Workflow for Glue accessing CloudWatch
      Path: '/'
      ManagedPolicyName: rhealth-etl-dev-workflow-Glue-Cloudwatch-Logs-etl-dev
      Roles:
        - !Ref rHealthWorkflowGlueToAccessS3CloudwatchlogsDev
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - logs:CreateLogDelivery
              - logs:GetLogDelivery
              - logs:UpdateLogDelivery
              - logs:DeleteLogDelivery
              - logs:ListLogDeliveries
              - logs:PutResourcePolicy
              - logs:PutResourcePolicy
              - logs:DescribeResourcePolicies
              - logs:DescribeLogGroups
            Resource: !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws-glue/*'

          - Effect: Allow
            Action:
              - tag:Get*
            Resource: '*'

  rHealthWorkflowGlueToAccessEc2S3LogsDev:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: IAM Policy for rHealth Workflow for Glue accessing EC2 and S3
      Path: '/'
      ManagedPolicyName: rhealth-etl-dev-workflow-Glue-To-Access-Ec2-S3-Logs-etl-dev
      Roles:
        - !Ref rHealthWorkflowGlueToAccessS3CloudwatchlogsDev
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - glue:*
              - cloudwatch:PutMetricData
            Resource: '*'
            Condition:
              StringEquals:
                aws:ResourceTag/Environment: rhealth-etl-dev

          - Effect: Allow
            Action:
              - glue:CreateSchema
              - glue:CreatePartition
              - glue:CreatePartitionIndex
              - glue:CreateTrigger
              - glue:DeletePartition
              - glue:DeletePartitionIndex
              - glue:DeleteTrigger
              - glue:UpdateColumnStatisticsForTable
              - glue:UpdateColumnStatisticsForPartition
              - glue:UpdatePartition
              - glue:UpdateSchema
              - glue:UpdateTable
              - glue:UpdateTrigger
              - glue:CreateTable
              - glue:BatchGetCrawlers
              - glue:CreateCrawler
              - glue:DeleteCrawler
              - glue:GetCrawler
              - glue:GetCrawlerMetrics
              - glue:GetCrawlers
              - glue:GetJobRun
              - glue:GetJobRuns
              - glue:GetJobs
              - glue:ListCrawlers
              - glue:ListCrawls
              - glue:StartCrawler
              - glue:StopCrawler
              - glue:StopCrawlerSchedule
              - glue:UpdateCrawler
            Resource:
              - !Sub 'arn:aws:glue:${AWS::Region}:${AWS::AccountId}:schema/*'
              - !Sub 'arn:aws:glue:${AWS::Region}:${AWS::AccountId}:catalog*'
              - !Sub 'arn:aws:glue:${AWS::Region}:${AWS::AccountId}:database/*'
              - !Sub 'arn:aws:glue:${AWS::Region}:${AWS::AccountId}:table/*/*'
              - !Sub 'arn:aws:glue:${AWS::Region}:${AWS::AccountId}:trigger/*'

          - Effect: Allow
            Action:
              - glue:Get*
              - glue:List*
              - ec2:DescribeVpcEndpoints
              - ec2:DescribeRouteTables
              - ec2:DescribeNetworkInterfaces
              - ec2:DescribeSecurityGroups
              - ec2:DescribeSubnets
              - ec2:DescribeVpcAttribute
              - iam:ListRolePolicies
              - iam:GetRole
              - iam:GetRolePolicy
            Resource: '*'

          - Effect: Allow
            Action:
              - ec2:CreateNetworkInterface
              - ec2:DeleteNetworkInterface
            Resource: '*'
            Condition:
              ForAllValues:StringEquals:
                aws:TagKeys: aws-glue-service-resource

          - Effect: Allow
            Action:
              - s3:GetObject
              - s3:PutObject
              - s3:DeleteObject
              - s3:ListBucket
            Resource:
              - !Ref MWAAS3BucketArn
              - !Join 
                - ''
                - - !Ref MWAAS3BucketArn
                  - '/*'
              - !Ref rHealthS3LandingBucketArn
              - !Join 
                  - ''
                  - - !Ref rHealthS3LandingBucketArn
                    - '/*'
              - !Ref rHealthS3LakeBucketArn
              - !Join 
                - ''
                - - !Ref rHealthS3LakeBucketArn
                  - '/*'
              - arn:aws:s3:::aws-glue-*/*
              - arn:aws:s3:::*/*aws-glue-*/*

          - Effect: Allow
            Action: s3:GetObject
            Resource:
              - arn:aws:s3:::crawler-public*
              - arn:aws:s3:::aws-glue-*

          - Effect: Allow
            Action:
              - logs:CreateLogGroup
              - logs:CreateLogStream
              - logs:PutLogEvents
              - logs:AssociateKmsKey
            Resource: !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws-glue/*'

          - Effect: Allow
            Action:
              - ec2:CreateTags
              - ec2:DeleteTags
            Resource:
              - arn:aws:ec2:*:*:network-interface/*
              - arn:aws:ec2:*:*:security-group/*
              - arn:aws:ec2:*:*:instance/*
            Condition:
              ForAllValues:StringEquals:
                aws:TagKeys: aws-glue-service-resource

          - Effect: Allow
            Action:
              - dynamodb:Get*
              - dynamodb:List*
              - dynamodb:BatchGet*
              - dynamodb:Describe*
              - dynamodb:Query
              - dynamodb:Scan
              - dynamodb:CreateTable
              - dynamodb:PutItem
              - dynamodb:UpdateItem
              - dynamodb:UpdateTable
              - dynamodb:BatchWriteItem
              - dynamodb:ConditionCheckItem
              - dynamodb:DeleteItem
              - dynamodb:DescribeTable
            Resource: '*'
            Condition:
              StringEquals:
                aws:ResourceTag/Environment: rhealth-etl-dev
  
  rHealthWorkflowGluePassRole:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: IAM Policy for rHealth Workflow for Glue pass role 
      Path: '/'
      ManagedPolicyName: rhealth-etl-dev-workflow-Glue-pass-role
      Roles:
        - !Ref rHealthWorkflowGlueToAccessS3CloudwatchlogsDev
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - iam:PassRole
            Resource: '*'
            
  rHealthWorkflowGlueToReadWriteS3Dev:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: IAM Policy for rHealth Workflow for Glue to R/W to S3
      Path: '/'
      ManagedPolicyName: rhealth-etl-dev-workflow-Glue-To-Read-Write-S3-etl-dev
      Roles:
        - !Ref rHealthWorkflowGlueToAccessS3CloudwatchlogsDev
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - s3:DeleteObject
              - s3:PutObject
              - s3:ListBucket
              - s3:GetBucketVersioning
              - s3:GetObjectVersion
              - s3:GetObjectAcl
              - s3:GetObject
            Resource:
              - !Ref rHealthS3LandingBucketArn
              - !Join
                - ''
                - - !Ref rHealthS3LandingBucketArn
                  - '/*'
              - !Ref rHealthS3LakeBucketArn
              - !Join
                - ''
                - - !Ref rHealthS3LakeBucketArn
                  - '/*' 
              - !Ref MWAAS3BucketArn
              - !Join 
                - ''
                - - !Ref MWAAS3BucketArn
                  - '/*'
          #- Effect: Allow
          #  Action:
          #    - kms:Decrypt
          #    - kms:Get*
          #    - kms:List*
          #    - kms:Describe*
          #    - kms:Encrypt
          #    - kms:GenerateDataKey*
          #  Resource:
          #    - !Ref S3KMSLakeKeyArn
          #    - !Ref S3KMSLandingKeyArn
          #    - !Ref CloudWatchKMSKeyArn

  rHealthWorkflowKmsToAccessGlueDev:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: IAM Policy for rHealth Workflow for KMS to access Glue
      Path: "/"
      ManagedPolicyName: rhealth-etl-dev-workflow-Kms-To-Access-Glue-etl-dev
      Roles:
        - !Ref rHealthWorkflowGlueToAccessS3CloudwatchlogsDev
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - kms:GetPublicKey
              - kms:Decrypt
              - kms:ListKeyPolicies
              - kms:ListRetirableGrants
              - kms:GetKeyPolicy
              - kms:GenerateDataKeyWithoutPlaintext
              - kms:Verify
              - kms:ListResourceTags
              - kms:GenerateDataKeyPairWithoutPlaintext
              - kms:GenerateDataKeyPair
              - kms:ReEncryptFrom
              - kms:ListGrants
              - kms:GetParametersForImport
              - kms:Encrypt
              - kms:GetKeyRotationStatus
              - kms:GenerateDataKey
              - kms:ReEncryptTo
              - kms:DescribeKey
              - kms:Sign
              - kms:DescribeCustomKeyStores
              - kms:ListKeys
              - kms:ListAliases
              - kms:GenerateRandom
              - kms:CreateKey
            Resource: '*'
  
  rHealthWorkflowGluetoAccessRedshift:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: IAM Policy for rHealth Workflow for Glue to Access Redshift
      Path: "/"
      ManagedPolicyName: rhealth-etl-dev-workflow-glue-to-access-redshift
      Roles:
        - !Ref rHealthWorkflowGlueToAccessS3CloudwatchlogsDev
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              # - redshift:*Cluster*
              # - redshift:ModifyClusterParameterGroup
              # - redshift:*SnapshotCopy
              # - redshift:ModifySnapshotCopyRetentionPeriod
              - redshift:*Quer*
              # - redshift:Restore*
              - redshift:*Tags
              - redshift:*List*
              - redshift:*Table*
              - redshift:*Fetch*
              # - redshift:CopyClusterSnapshot
              # - redshift:CreateClusterSnapshot
              # - redshift:*EventSubscription
              # - redshift:RebootCluster
              # - redshift:RotateEncryptionKey
            Resource: '*'

  rHealthWorkflowGluetoAccessAthena:
      Type: AWS::IAM::ManagedPolicy
      Properties:
        Description: IAM Policy for rHealth Workflow for Glue to Access Atnena
        Path: "/"
        ManagedPolicyName: rhealth-etl-dev-workflow-glue-to-access-athena
        Roles:
          - !Ref rHealthWorkflowGlueToAccessS3CloudwatchlogsDev
        PolicyDocument:
          Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - athena:GetWorkGroup
                - athena:StartQueryExecution
                - athena:StopQueryExecution
                - athena:GetQueryExecution
                - athena:GetQueryResults
                - athena:GetDataCatalog
              Resource: '*'

  LambdaExecutionRole:
    Type: 'AWS::IAM::Role'
    Properties:
      Description: The role for running the lambda
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
              - lambda.amazonaws.com
            Action:
              - 'sts:AssumeRole'
      PermissionsBoundary: !Ref VPCxPermissionBoundary
      Tags:
       - Key: Environment
         Value: rhealth-etl-dev
      Policies:
        - PolicyName: rhealth-etl-dev-workflow-pass-role
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action: 
                  - iam:PassRole
                Resource: '*'
        - PolicyName: rhealth-etl-dev-workflow-lambda-access-ddb
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                - dynamodb:Get*
                - dynamodb:List*
                - dynamodb:BatchGet*
                - dynamodb:Describe*
                - dynamodb:Query
                - dynamodb:Scan
                - dynamodb:CreateTable
                - dynamodb:PutItem
                - dynamodb:UpdateItem
                - dynamodb:UpdateTable
                - dynamodb:BatchWriteItem
                - dynamodb:ConditionCheckItem
                - dynamodb:DeleteItem
                - dynamodb:DescribeTable
                Resource: '*'
                Condition:
                  StringEquals:
                    aws:ResourceTag/Environment: rhealth-etl-dev
        - PolicyName: rhealth-etl-dev-worlflow-lambda-access-mwaa
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - airflow:*
                Resource: '*'
                Condition:
                  StringEquals:
                    aws:ResourceTag/Environment: rhealth-etl-dev
        - PolicyName: rhealth-etl-dev-worlflow-lambda-access-cw
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogDelivery
                  - logs:GetLogDelivery
                  - logs:UpdateLogDelivery
                  - logs:DeleteLogDelivery
                  - logs:ListLogDeliveries
                  - logs:PutResourcePolicy
                  - logs:DescribeResourcePolicies
                  - logs:DescribeLogGroups
                Resource: '*'
                Condition:
                  StringEquals:
                    aws:ResourceTag/Environment: rhealth-etl-dev
        - PolicyName: rhealth-etl-dev-worlflow-lambda-access-kms
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - kms:GetPublicKey
                  - kms:Decrypt
                  - kms:ListKeyPolicies
                  - kms:ListRetirableGrants
                  - kms:GetKeyPolicy
                  - kms:GenerateDataKeyWithoutPlaintext
                  - kms:Verify
                  - kms:ListResourceTags
                  - kms:GenerateDataKeyPairWithoutPlaintext
                  - kms:GenerateDataKeyPair
                  - kms:ReEncryptFrom
                  - kms:ListGrants
                  - kms:GetParametersForImport
                  - kms:Encrypt
                  - kms:GetKeyRotationStatus
                  - kms:GenerateDataKey
                  - kms:ReEncryptTo
                  - kms:DescribeKey
                  - kms:Sign
                  - kms:DescribeCustomKeyStores
                  - kms:ListKeys
                  - kms:ListAliases
                  - kms:GenerateRandom
                  - kms:CreateKey
            Resource: '*'
            Condition:
                StringEquals:
                  aws:ResourceTag/Environment: rhealth-etl-dev    
        - PolicyName: rhealth-etl-dev-worlflow-lambda-access-s3
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - s3:DeleteObject
                  - s3:PutObject
                  - s3:ListBucket
                  - s3:GetBucketVersioning
                  - s3:GetObjectVersion
                  - s3:GetObjectAcl
                  - s3:GetObject
                  - s3:Describe*
                Resource:
                  - !Ref rHealthS3LandingBucketArn
                  - !Join
                    - ''
                    - - !Ref rHealthS3LandingBucketArn
                      - '/*'
                  - !Ref rHealthS3LakeBucketArn
                  - !Join
                    - ''
                    - - !Ref rHealthS3LakeBucketArn
                      - '/*' 
                  - !Ref MWAAS3BucketArn
                  - !Join 
                    - ''
                    - - !Ref MWAAS3BucketArn
                      - '/*'
        - PolicyName: rhealth-etl-dev-worlflow-lambda-access-ec2-mwaa
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - ec2:DescribeInstances
                  - ec2:CreateNetworkInterface
                  - ec2:AttachNetworkInterface
                  - ec2:DescribeNetworkInterfaces
                  - autoscaling:CompleteLifecycleAction
                  - ec2:DeleteNetworkInterface
                Resource: '*'

  #####################################################################################################################
  # CREATE MWAA bucket and bucket policy
  #####################################################################################################################

  # EnvironmentBucket:
  #   Type: AWS::S3::Bucket
  #   Properties:
  #     BucketName: !Ref MWAAS3Bucket
  #     VersioningConfiguration:
  #       Status: Enabled
  #     PublicAccessBlockConfiguration:
  #       BlockPublicAcls: true
  #       BlockPublicPolicy: true
  #       IgnorePublicAcls: true
  #       RestrictPublicBuckets: true

  # MWAAbucketPolicy:
  #   Type: AWS::S3::BucketPolicy
  #   Properties:
  #     Bucket: !Ref EnvironmentBucket
  #     PolicyDocument:
  #       Statement:
  #         -
  #           Action:
  #             - s3:GetObject*
  #             - s3:List*
  #             - s3:GetBucket*
  #             - s3:DeleteObject*

  #           Effect: Allow
  #           Resource:
  #             - !Sub arn:aws:s3:::${EnvironmentBucket}
  #             - !Sub arn:aws:s3:::${EnvironmentBucket}/*
  #           Principal:
  #             AWS:
  #               - !GetAtt MwaaExecutionRole.Arn
            
  #           Resource:
  #             - Fn::GetAtt:
  #                 - EnvironmentBucket
  #                 - Arn
  #             - Fn::Join:
  #                 - ""
  #                 - - Fn::GetAtt:
  #                       - EnvironmentBucket
  #                       - Arn
  #                   - /*

  #####################################################################################################################
  # CREATE MWAA environment
  #####################################################################################################################

  MwaaEnvironment:
    Type: AWS::MWAA::Environment
    DependsOn: MwaaExecutionPolicy
    Properties:
      Name: !Sub "${AWS::StackName}-MwaaEnvironment"
      SourceBucketArn: !Ref MWAAS3BucketArn 
      ExecutionRoleArn: !GetAtt MwaaExecutionRole.Arn
      EnvironmentClass: !Ref EnvClass # e.g. mw1.small
      AirflowVersion: !Ref MWAAVersion
      DagS3Path: dags
      #RequirementsS3Path: requirements.txt
      #PluginsS3Path: plugins.zip
      NetworkConfiguration:
        SecurityGroupIds: !Ref ExistingSecurityGroup
        SubnetIds:
          - !Ref Subnet1
          - !Ref Subnet2
      WebserverAccessMode: PUBLIC_ONLY
      MaxWorkers: !Ref MaxWorkerNodes
      LoggingConfiguration:
        DagProcessingLogs:
          LogLevel: !Ref DagProcessingLogs
          Enabled: true
        SchedulerLogs:
          LogLevel: !Ref SchedulerLogsLevel
          Enabled: true
        TaskLogs:
          LogLevel: !Ref TaskLogsLevel
          Enabled: true
        WorkerLogs:
          LogLevel: !Ref WorkerLogsLevel
          Enabled: true
        WebserverLogs:
          LogLevel: !Ref WebserverLogsLevel
          Enabled: true


  MwaaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - airflow-env.amazonaws.com
                - airflow.amazonaws.com
            Action:
             - "sts:AssumeRole"
      Path: "/service-role/"
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/SecretsManagerReadWrite
        - arn:aws:iam::aws:policy/service-role/AWSGlueServiceRole
        - arn:aws:iam::aws:policy/AWSLambdaExecute
      PermissionsBoundary: !Ref VPCxPermissionBoundary
      Tags:
       - Key: Environment
         Value: rhealth-etl-dev
      Policies:
        - PolicyName: rhealth-etl-dev-workflow-mwaa-access-glue
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - glue:CreateJob
                  - glue:GetJobs
                  - glue:ResetJobBookmark
                  - glue:StartJobRun
                  - glue:GetJobRun
                  - glue:UpdateJob
                  - glue:DeleteJob
                  - glue:GetJobRuns
                  - glue:GetJob
                Resource: "*"
        - PolicyName: rhealth-etl-dev-workflow-s3-access-code-policy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObjectAcl
                  - s3:GetObject
                  - s3:GetBucketAcl
                Resource: 
                  - !Ref MWAAS3BucketArn
                  - !Join 
                    - ''
                    - - !Ref MWAAS3BucketArn
                      - '/*' 

  MwaaExecutionPolicy:
    #DependsOn: EnvironmentBucket
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Roles:
        - !Ref MwaaExecutionRole
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action: airflow:PublishMetrics
            Resource:
              - !Sub "arn:aws:airflow:${AWS::Region}:${AWS::AccountId}:environment/${AWS::StackName}-MwaaEnvironment"
          - Effect: Deny
            Action: s3:ListAllMyBuckets
            Resource: 
              - !Ref MWAAS3BucketArn
              - !Join 
                - ''
                - - !Ref MWAAS3BucketArn
                  - '/*' 

          - Effect: Allow
            Action:
              - "s3:*"
            Resource: 
              - !Ref MWAAS3BucketArn
              - !Join 
                - ''
                - - !Ref MWAAS3BucketArn
                  - '/*'
          - Effect: Allow
            Action:
              - logs:CreateLogStream
              - logs:CreateLogGroup
              - logs:PutLogEvents
              - logs:GetLogEvents
              - logs:GetLogRecord
              - logs:GetLogGroupFields
              - logs:GetQueryResults
              - logs:DescribeLogGroups
            Resource: "*"
              
          - Effect: Allow
            Action: cloudwatch:PutMetricData
            Resource: "*"
          
          - Effect: Allow
            Action:
              - sqs:ChangeMessageVisibility
              - sqs:DeleteMessage
              - sqs:GetQueueAttributes
              - sqs:GetQueueUrl
              - sqs:ReceiveMessage
              - sqs:SendMessage
            Resource:
              - !Sub "arn:aws:sqs:${AWS::Region}:*:airflow-celery-*"
          
          - Effect: Allow
            Action:
              - kms:Decrypt
              - kms:DescribeKey
              - kms:GenerateDataKey*
              - kms:Encrypt
            NotResource: !Sub "arn:aws:kms:*:${AWS::AccountId}:key/*"
            Condition:
              StringLike:
                "kms:ViaService":
                  - !Sub "sqs.${AWS::Region}.amazonaws.com"

          - Effect: Allow
            Action: airflow:*
            Resource: 
              - !Sub "arn:aws:airflow:${AWS::Region}:${AWS::AccountId}:role/AmazonMWAAExecutionRole/Admin"
              - !Sub "arn:aws:airflow:${AWS::Region}:${AWS::AccountId}:environment/*"
              - !Sub "arn:aws:airflow:${AWS::Region}:${AWS::AccountId}:role/rhealth-etl-dev-airflow-vpc3/Admin"
              
          - Effect: Allow
            Action: airflow:CreateWebLoginToken
            Resource: 
              - !Sub "arn:aws:airflow:${AWS::Region}:${AWS::AccountId}:role/AmazonMWAAExecutionRole/Admin"
              - !Sub "arn:aws:airflow:${AWS::Region}:${AWS::AccountId}:environment/*"
              - !Sub "arn:aws:airflow:${AWS::Region}:${AWS::AccountId}:role/rhealth-etl-dev-airflow-vpc3/Admin"
         
          - Effect: Allow
            Action: s3:GetAccountPublicAccessBlock
            Resource: "*"